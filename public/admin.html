<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Titi Invita</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // SCRIPT INLINE - NO DEPENDE DE ARCHIVOS EXTERNOS
        console.log('=================================');
        console.log('üöÄ SCRIPT INLINE EJECUT√ÅNDOSE');
        console.log('=================================');
        
        const API_BASE = 'https://titi-invita-app-azhcw.ondigitalocean.app/api';
        let allUsers = [];
        let allEvents = [];
        
        // Verificar sesi√≥n INMEDIATAMENTE
        const usuarioStr = localStorage.getItem('titi_usuario_actual');
        if (!usuarioStr) {
            alert('No hay sesi√≥n activa. Redirigiendo a login...');
            window.location.href = 'login.html';
        }
        
        function obtenerToken() {
            let token = localStorage.getItem('titi_token');
            if (!token) token = sessionStorage.getItem('titi_token');
            if (!token) {
                const sesion = localStorage.getItem('titi_sesion') || sessionStorage.getItem('titi_sesion');
                if (sesion) {
                    try { token = JSON.parse(sesion).token; } catch (e) {}
                }
            }
            return token;
        }
        
        function showPage(pageName) {
            console.log('üìÑ Mostrando p√°gina:', pageName);
            
            // Ocultar todas
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Mostrar seleccionada
            const page = document.getElementById(pageName);
            if (page) {
                page.style.display = 'block';
                console.log('‚úÖ P√°gina visible');
            }
            
            const nav = document.querySelector('[data-page="' + pageName + '"]');
            if (nav) nav.classList.add('active');
            
            // Cargar datos
            if (pageName === 'usuarios') cargarUsuarios();
            if (pageName === 'eventos') cargarEventos();
        }
        
        async function cargarUsuarios() {
            console.log('üîÑ Cargando usuarios...');
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) {
                console.error('‚ùå No existe usersTableBody');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">‚è≥ Cargando...</td></tr>';
            
            try {
                const token = obtenerToken();
                console.log('üîë Token:', token ? 'Presente' : 'Ausente');
                
                const response = await fetch(API_BASE + '/usuarios', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                allUsers = await response.json();
                console.log('‚úÖ Usuarios:', allUsers.length);
                
                if (allUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No hay usuarios</td></tr>';
                } else {
                    let html = '';
                    allUsers.forEach(u => {
                        html += '<tr>' +
                            '<td>' + u.id + '</td>' +
                            '<td><strong>' + u.nombre + '</strong></td>' +
                            '<td>' + u.email + '</td>' +
                            '<td><span style="padding:4px 8px; background:#e8f5e9; color:#2e7d32; border-radius:4px">' + u.rol + '</span></td>' +
                            '<td>0</td>' +
                            '<td>' + (u.fecha_creacion || '-') + '</td>' +
                            '<td>-</td>' +
                            '</tr>';
                    });
                    tbody.innerHTML = html;
                    console.log('‚úÖ Tabla renderizada');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red">Error: ' + error.message + '</td></tr>';
            }
        }
        
        async function cargarEventos() {
            console.log('üîÑ Cargando eventos...');
            const container = document.getElementById('eventsContainer');
            if (!container) {
                console.error('‚ùå No existe eventsContainer');
                return;
            }
            
            container.innerHTML = '<p style="text-align:center">‚è≥ Cargando...</p>';
            
            try {
                const token = obtenerToken();
                const response = await fetch(API_BASE + '/eventos-admin', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                allEvents = await response.json();
                console.log('‚úÖ Eventos:', allEvents.length);
                
                if (allEvents.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#999">No hay eventos</p>';
                } else {
                    let html = '<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px">';
                    allEvents.forEach(e => {
                        html += '<div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1)">' +
                            '<h3 style="margin:0 0 10px 0">' + e.nombre + '</h3>' +
                            '<p style="margin:5px 0; color:#666"><i class="fas fa-calendar"></i> ' + (e.fecha_evento || 'Sin fecha') + '</p>' +
                            '<p style="margin:5px 0; color:#666"><i class="fas fa-map-marker-alt"></i> ' + (e.ubicacion || 'Sin ubicaci√≥n') + '</p>' +
                            '</div>';
                    });
                    html += '</div>';
                    container.innerHTML = html;
                    console.log('‚úÖ Eventos renderizados');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                container.innerHTML = '<p style="text-align:center; color:red">Error: ' + error.message + '</p>';
            }
        }
        
        // Cuando carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM Listo');
            
            // Mostrar dashboard por defecto
            showPage('dashboard');
            cargarUsuarios();
            cargarEventos();
            
            // Configurar logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.onclick = function() {
                    if (confirm('¬øCerrar sesi√≥n?')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    }
                };
            }
        });
    </script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-calendar-check"></i>
                <h2>Titi Invita</h2>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <a>Dashboard</a>
                </div>
                <div class="nav-item" data-page="usuarios" onclick="showPage('usuarios')">
                    <i class="fas fa-users"></i>
                    <a>Usuarios</a>
                </div>
                <div class="nav-item" data-page="eventos" onclick="showPage('eventos')">
                    <i class="fas fa-calendar-alt"></i>
                    <a>Eventos</a>
                </div>
                <div class="nav-item" data-page="mis-eventos" onclick="showPage('mis-eventos')">
                    <i class="fas fa-calendar-plus"></i>
                    <a>Mis Eventos</a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="nav-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <a>Cerrar Sesi√≥n</a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="pageTitle">Dashboard Admin</h1>
            </header>

            <!-- Dashboard -->
            <div class="page" id="dashboard" style="display:block; padding:30px">
                <h2>Panel de Control</h2>
                <p>Bienvenido al panel de administraci√≥n</p>
                
                <div style="margin-top:30px">
                    <button onclick="cargarUsuarios()" style="padding:12px 24px; background:#764ba2; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600">
                        <i class="fas fa-sync-alt"></i> Recargar Usuarios
                    </button>
                    <button onclick="cargarEventos()" style="padding:12px 24px; background:#764ba2; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; margin-left:10px">
                        <i class="fas fa-sync-alt"></i> Recargar Eventos
                    </button>
                </div>
            </div>

            <!-- Usuarios -->
            <div class="page" id="usuarios" style="display:none; padding:30px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                    <h2>Gesti√≥n de Usuarios</h2>
                    <button onclick="cargarUsuarios()" style="padding:10px 20px; background:#764ba2; color:white; border:none; border-radius:8px; cursor:pointer">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                    <table style="width:100%; border-collapse:collapse">
                        <thead style="background:#f5f6fa">
                            <tr>
                                <th style="padding:16px; text-align:left; font-weight:600">ID</th>
                                <th style="padding:16px; text-align:left; font-weight:600">NOMBRE</th>
                                <th style="padding:16px; text-align:left; font-weight:600">EMAIL</th>
                                <th style="padding:16px; text-align:left; font-weight:600">ROL</th>
                                <th style="padding:16px; text-align:left; font-weight:600">EVENTOS</th>
                                <th style="padding:16px; text-align:left; font-weight:600">REGISTRO</th>
                                <th style="padding:16px; text-align:left; font-weight:600">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" style="padding:40px; text-align:center; color:#999">
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Eventos -->
            <div class="page" id="eventos" style="display:none; padding:30px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                    <h2>Todos los Eventos</h2>
                    <button onclick="cargarEventos()" style="padding:10px 20px; background:#764ba2; color:white; border:none; border-radius:8px; cursor:pointer">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div id="eventsContainer">
                    <p style="text-align:center; color:#999">Cargando eventos...</p>
                </div>
            </div>

            <!-- Mis Eventos -->
            <div class="page" id="mis-eventos" style="display:none">
                <iframe src="cliente.html" style="width:100%; height:calc(100vh - 100px); border:none; border-radius:12px"></iframe>
            </div>
        </main>
    </div>
</body>
</html>
