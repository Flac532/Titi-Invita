<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Titi Invita</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        console.log('=================================');
        console.log('üöÄ ADMIN PANEL INICIANDO');
        console.log('=================================');
        
        const API_BASE = 'https://titi-invita-app-azhcw.ondigitalocean.app/api';
        let allUsers = [];
        let allEvents = [];
        
        // Verificar sesi√≥n
        const usuarioStr = localStorage.getItem('titi_usuario_actual');
        if (!usuarioStr) {
            alert('No hay sesi√≥n activa. Redirigiendo a login...');
            window.location.href = 'login.html';
        }
        
        function obtenerToken() {
            let token = localStorage.getItem('titi_token');
            if (!token) token = sessionStorage.getItem('titi_token');
            if (!token) {
                const sesion = localStorage.getItem('titi_sesion') || sessionStorage.getItem('titi_sesion');
                if (sesion) {
                    try { token = JSON.parse(sesion).token; } catch (e) {}
                }
            }
            console.log('üîë Token obtenido:', token ? 'SI (' + token.substring(0, 20) + '...)' : 'NO');
            return token;
        }
        
        function showPage(pageName) {
            console.log('');
            console.log('üìÑ showPage(' + pageName + ')');
            
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const page = document.getElementById(pageName);
            if (page) {
                page.style.display = 'block';
                console.log('‚úÖ P√°gina visible');
            }
            
            const nav = document.querySelector('[data-page="' + pageName + '"]');
            if (nav) nav.classList.add('active');
            
            if (pageName === 'usuarios') cargarUsuarios();
            if (pageName === 'eventos') cargarEventos();
        }
        
        async function cargarUsuarios() {
            console.log('');
            console.log('üîÑ ============ CARGANDO USUARIOS ============');
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) {
                console.error('‚ùå No existe usersTableBody');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px">‚è≥ Cargando usuarios...</td></tr>';
            
            try {
                const token = obtenerToken();
                if (!token) {
                    throw new Error('No hay token disponible');
                }
                
                console.log('üì° Llamando a:', API_BASE + '/usuarios');
                
                const response = await fetch(API_BASE + '/usuarios', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    throw new Error('HTTP ' + response.status + ': ' + errorText.substring(0, 100));
                }
                
                const data = await response.json();
                console.log('üì¶ Datos recibidos (tipo):', typeof data);
                console.log('üì¶ Es array?:', Array.isArray(data));
                console.log('üì¶ Datos:', data);
                
                // ASEGURAR QUE SEA ARRAY
                if (Array.isArray(data)) {
                    allUsers = data;
                } else if (data && typeof data === 'object' && data.usuarios) {
                    allUsers = data.usuarios;
                } else if (data && typeof data === 'object') {
                    // Si es un objeto, intentar convertirlo a array
                    allUsers = Object.values(data);
                } else {
                    allUsers = [];
                }
                
                console.log('‚úÖ allUsers (array):', allUsers.length, 'elementos');
                
                if (allUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999">No hay usuarios registrados</td></tr>';
                } else {
                    let html = '';
                    for (let i = 0; i < allUsers.length; i++) {
                        const u = allUsers[i];
                        console.log('  üë§ Usuario ' + (i+1) + ':', u.nombre, '-', u.email);
                        html += '<tr>' +
                            '<td style="padding:12px">' + u.id + '</td>' +
                            '<td style="padding:12px"><strong>' + u.nombre + '</strong></td>' +
                            '<td style="padding:12px">' + u.email + '</td>' +
                            '<td style="padding:12px"><span style="padding:4px 12px; background:#e8f5e9; color:#2e7d32; border-radius:12px; font-size:0.85rem; font-weight:600">' + u.rol + '</span></td>' +
                            '<td style="padding:12px">0</td>' +
                            '<td style="padding:12px">' + (u.fecha_creacion ? new Date(u.fecha_creacion).toLocaleDateString() : '-') + '</td>' +
                            '<td style="padding:12px">-</td>' +
                            '</tr>';
                    }
                    tbody.innerHTML = html;
                    console.log('‚úÖ Tabla renderizada con', allUsers.length, 'filas');
                }
            } catch (error) {
                console.error('‚ùå ERROR COMPLETO:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#d32f2f"><i class="fas fa-exclamation-circle"></i><br><br><strong>Error al cargar usuarios</strong><br>' + error.message + '</td></tr>';
            }
            console.log('============================================');
        }
        
        async function cargarEventos() {
            console.log('');
            console.log('üîÑ ============ CARGANDO EVENTOS ============');
            const container = document.getElementById('eventsContainer');
            if (!container) {
                console.error('‚ùå No existe eventsContainer');
                return;
            }
            
            container.innerHTML = '<p style="text-align:center; padding:40px">‚è≥ Cargando eventos...</p>';
            
            try {
                const token = obtenerToken();
                if (!token) {
                    throw new Error('No hay token disponible');
                }
                
                console.log('üì° Llamando a:', API_BASE + '/eventos-admin');
                
                const response = await fetch(API_BASE + '/eventos-admin', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    throw new Error('HTTP ' + response.status);
                }
                
                const data = await response.json();
                console.log('üì¶ Datos recibidos:', typeof data, Array.isArray(data));
                
                // ASEGURAR QUE SEA ARRAY
                if (Array.isArray(data)) {
                    allEvents = data;
                } else if (data && typeof data === 'object' && data.eventos) {
                    allEvents = data.eventos;
                } else {
                    allEvents = [];
                }
                
                console.log('‚úÖ allEvents:', allEvents.length, 'elementos');
                
                if (allEvents.length === 0) {
                    container.innerHTML = '<p style="text-align:center; padding:40px; color:#999">No hay eventos registrados</p>';
                } else {
                    let html = '<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:24px">';
                    for (let i = 0; i < allEvents.length; i++) {
                        const e = allEvents[i];
                        console.log('  üìÖ Evento ' + (i+1) + ':', e.nombre);
                        html += '<div style="background:white; padding:24px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition:all 0.2s" onmouseover="this.style.transform=\'translateY(-4px)\'; this.style.boxShadow=\'0 8px 20px rgba(0,0,0,0.12)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.08)\'">' +
                            '<h3 style="margin:0 0 12px 0; color:#2d3748">' + e.nombre + '</h3>' +
                            '<p style="margin:8px 0; color:#718096; font-size:0.9rem"><i class="fas fa-calendar" style="margin-right:8px; color:#764ba2"></i>' + (e.fecha_evento ? new Date(e.fecha_evento).toLocaleDateString() : 'Sin fecha') + '</p>' +
                            '<p style="margin:8px 0; color:#718096; font-size:0.9rem"><i class="fas fa-map-marker-alt" style="margin-right:8px; color:#764ba2"></i>' + (e.ubicacion || 'Sin ubicaci√≥n') + '</p>' +
                            '<p style="margin:8px 0; color:#718096; font-size:0.9rem"><i class="fas fa-table" style="margin-right:8px; color:#764ba2"></i>' + (e.mesas ? e.mesas.length : 0) + ' mesas</p>' +
                            '</div>';
                    }
                    html += '</div>';
                    container.innerHTML = html;
                    console.log('‚úÖ Eventos renderizados');
                }
            } catch (error) {
                console.error('‚ùå ERROR:', error);
                container.innerHTML = '<p style="text-align:center; padding:40px; color:#d32f2f"><i class="fas fa-exclamation-circle"></i><br><br><strong>Error al cargar eventos</strong><br>' + error.message + '</p>';
            }
            console.log('============================================');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM Cargado');
            
            showPage('dashboard');
            cargarUsuarios();
            cargarEventos();
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.onclick = function() {
                    if (confirm('¬øCerrar sesi√≥n?')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    }
                };
            }
            
            console.log('‚úÖ Admin panel listo');
        });
    </script>
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-calendar-check"></i>
                <h2>Titi Invita</h2>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <a>Dashboard</a>
                </div>
                <div class="nav-item" data-page="usuarios" onclick="showPage('usuarios')">
                    <i class="fas fa-users"></i>
                    <a>Usuarios</a>
                </div>
                <div class="nav-item" data-page="eventos" onclick="showPage('eventos')">
                    <i class="fas fa-calendar-alt"></i>
                    <a>Eventos</a>
                </div>
                <div class="nav-item" data-page="mis-eventos" onclick="showPage('mis-eventos')">
                    <i class="fas fa-calendar-plus"></i>
                    <a>Mis Eventos</a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="nav-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <a>Cerrar Sesi√≥n</a>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <h1>Dashboard Admin</h1>
            </header>

            <div class="page" id="dashboard" style="display:block; padding:30px">
                <h2>Panel de Control</h2>
                <div style="margin-top:30px">
                    <button onclick="cargarUsuarios()" style="padding:12px 24px; background:linear-gradient(135deg, #764ba2, #9a7bb8); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(118,75,162,0.3)">
                        <i class="fas fa-sync-alt"></i> Recargar Usuarios
                    </button>
                    <button onclick="cargarEventos()" style="padding:12px 24px; background:linear-gradient(135deg, #764ba2, #9a7bb8); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; margin-left:10px; box-shadow:0 4px 12px rgba(118,75,162,0.3)">
                        <i class="fas fa-sync-alt"></i> Recargar Eventos
                    </button>
                </div>
            </div>

            <div class="page" id="usuarios" style="display:none; padding:30px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
                    <h2 style="margin:0">Gesti√≥n de Usuarios</h2>
                    <button onclick="cargarUsuarios()" style="padding:12px 24px; background:linear-gradient(135deg, #764ba2, #9a7bb8); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(118,75,162,0.3)">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                    <table style="width:100%; border-collapse:collapse">
                        <thead style="background:#fafbfc">
                            <tr>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">ID</th>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">NOMBRE</th>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">EMAIL</th>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">ROL</th>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">EVENTOS</th>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">REGISTRO</th>
                                <th style="padding:16px; text-align:left; font-weight:600; text-transform:uppercase; font-size:0.85rem; color:#2d3748; letter-spacing:0.5px">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" style="background:white">
                            <tr>
                                <td colspan="7" style="padding:40px; text-align:center; color:#999">
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="page" id="eventos" style="display:none; padding:30px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
                    <h2 style="margin:0">Todos los Eventos</h2>
                    <button onclick="cargarEventos()" style="padding:12px 24px; background:linear-gradient(135deg, #764ba2, #9a7bb8); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(118,75,162,0.3)">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div id="eventsContainer">
                    <p style="text-align:center; padding:40px; color:#999">Cargando eventos...</p>
                </div>
            </div>

            <div class="page" id="mis-eventos" style="display:none">
                <iframe src="cliente.html" style="width:100%; height:calc(100vh - 100px); border:none; border-radius:12px"></iframe>
            </div>
        </main>
    </div>
</body>
</html>
